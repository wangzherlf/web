<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="专注前端开发, 关注用户体验">
    <meta name="keyword" content="javascript">
    <link rel="shortcut icon" href="/web/img/favicon.ico">

    <title>
        
        koa.md - Rafael.ru的博客 | Rafael.ru&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/web/css/aircloud.css">
    <link rel="stylesheet" href="/web/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/web/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>Rafael.ru</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/web/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/web/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/web/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/web/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">什么是Node.js</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">Npm</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">完全符合CommonJS规范的npm模块结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">NVM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">在npm.org上发布一个模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">KOA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">Express和Koa的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">koa安装及搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">context对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text">常用属性和方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">koa的中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#null"><span class="toc-text">路由</span></a></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        koa.md
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2019-07-03 01:01:56</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/web/tags/#koa" title="koa">koa</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2><span id="什么是nodejs">什么是Node.js</span></h2><p>node.js是一个基于chrome v8引擎的javascript运行时环境。使用了事件驱动、非阻塞式I/O模型<br><code>运行时环境</code>也叫运行时Managed Runtime Environment，即托管运行时环境<br>运行时是一个平台，它把运行在底层操作系统和体系结构的特点抽象出来，承担了解释与编译、堆管理(Heap Management)、垃圾回收机制(Garbage Collection)、内存分配(Memory Allocation)、安全机制(Security)等功能<br>运行时环境也叫做虚拟机</p>
<p>javascirpt运行时环境是一个能够运行javascript语句的运行环境，它提供了一些列以往由处理器和操作系统才能提供的功能，使得开发者能够脱离底层指令，从而专注业务逻辑开发</p>
<p>chrome v8引擎是一个高性能的javascript解释引擎。chrome浏览器内核是webkit的一个分支。webkit分为渲染引擎webCore和js解释引擎javascriptCore两个部分。google认为javascriptCore引擎运行效率不高，因此开发了高性能的javascript引擎v8</p>
<p><strong>使用node.js搭建一个http server</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">const http = require(&apos;http&apos;)</span><br><span class="line">const fs = require(&apos;fs&apos;)</span><br><span class="line">const url = require(&apos;url&apos;)</span><br><span class="line">const path = require(&apos;path&apos;)</span><br><span class="line">const hostname = &apos;127.0.0.1&apos;</span><br><span class="line">const port = 8080</span><br><span class="line"></span><br><span class="line">const server = http.createServer((req, res) =&gt; &#123;</span><br><span class="line">    let pathname = url.parse(req.url).pathname</span><br><span class="line">    let extname = url.parse(pathname)</span><br><span class="line">    if (pathname == &apos;/&apos;) &#123;</span><br><span class="line">        res.writeHead(200, &#123;&apos;Content-Type&apos;: &apos;text/html&apos;&#125;)</span><br><span class="line">        res.end(fs.readFileSync(path.join(__dirname, pathname, &apos;test.html&apos;)))</span><br><span class="line">    &#125; else if (extname == &apos;.jpg&apos; || extname == &apos;.png&apos;) &#123;</span><br><span class="line">        res.writeHead(200, &#123;&apos;Content-Type&apos;: &apos;image/&apos; + extname.substr(1)&#125;)</span><br><span class="line">        res.end(fs.readFileSync(path.join(__dirname, pathname)))</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        res.statusCode = 404;</span><br><span class="line">        res.end()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(port, hostname, () =&gt; &#123;</span><br><span class="line">    console.log(`server running at http://$&#123;hostname&#125;:$&#123;port&#125;`)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2><span id="npm">Npm</span></h2><p><a href="https://docs.npmjs.com" target="_blank" rel="noopener">npm</a> (Node Package Manager)是一个javascript模块管理工具，遵循CommonJS标准</p>
<p>用于管理模块的安装、卸载和依赖项</p>
<p><strong>npm常用命令</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">npm access           设置模块的访问级别</span><br><span class="line">npm adduser          添加用户</span><br><span class="line">npm cache (npm -c)   管理模块缓存</span><br><span class="line">npm config           管理Npm配置文件</span><br><span class="line">npm help (npm -h)    查看npm帮助信息</span><br><span class="line">npm init             引导创建package,json文件</span><br><span class="line">npm ls               查看已安装的模块</span><br><span class="line">npm publish          发布模块</span><br><span class="line">npm root             显示Npm根目录</span><br><span class="line">npm start            启动模块</span><br><span class="line">npm test             测试模块</span><br><span class="line">npm update (npm -up) 更新模块</span><br><span class="line">npm verison (npm -v) 查看npm版本信息</span><br><span class="line">npm init -y          初始化</span><br><span class="line">npm init —yes        初始化</span><br><span class="line">npm root -g          查看全局包位置</span><br></pre></td></tr></table></figure>

<h3><span id="完全符合commonjs规范的npm模块结构">完全符合CommonJS规范的npm模块结构</span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package.json  模块的描述文件</span><br><span class="line">bin    存放可执行的二进制文件</span><br><span class="line">lib    存放javascript代码</span><br><span class="line">doc    存放文档</span><br><span class="line">test   存放单元测试用例</span><br></pre></td></tr></table></figure>

<h3><span id="packagejson常用字段"></span></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">description       模块描述</span><br><span class="line">name              模块名字</span><br><span class="line">version           版本号</span><br><span class="line">keywords          关键字</span><br><span class="line">license           许可证</span><br><span class="line">author            开发者</span><br><span class="line">scripts           可用于运行的脚本命令</span><br><span class="line">dependencies      正常运行时所需的模块</span><br><span class="line">devDependencies   开发时所需的模块</span><br></pre></td></tr></table></figure>

<p>对于相同的package.json文件，输入安装命令，输出的模块包应该是一致的，然后并不一致，主要原因是</p>
<ul>
<li>npm采用的安装算法稍有不同</li>
<li>在最近一次安装之后，模块进行了版本更新，由于会自动采用最新版本(而非预先设定的版本)</li>
<li>即使锁定了版本信息，如果模块的依赖包进行了更新，模块也会自动更新</li>
<li>更新了新的下载源</li>
</ul>
<p>这些都是因为Npm的版本兼容机制非常宽松造成的。</p>
<p><code>package-lock.json</code> 锁定了依赖版本号和来源，是npm为了防止模块包的不一致而进行的功能加强。这个文件在运行命令<code>npm install</code>的时候为了锁定依赖版本和来源由npm自动创建，记录了当前状态下安装的所有模块信息，确保了在下载时间，开发者，机器和下载源都不相同的情况下也能够得到完全一样的模块包</p>
<h2><span id="nvm">NVM</span></h2><ol>
<li><p>卸载已经全局安装的node.js和npm(推荐，非必须)</p>
<ul>
<li><p>删除<code>/usr/local/lib</code>和<code>/usr/local/include</code>两个文件夹中所有和node.js及node_modules相关的文件</p>
</li>
<li><p>检查个人主文件夹下所有<code>local</code>,<code>lib</code>,<code>include</code>文件夹并删除所有与node.js和node_modules有关的内容</p>
</li>
<li><p>从<code>/usr/local/bin</code>中删除node.js的可执行文件</p>
</li>
<li><p>使用brew安装的node.js还需要运行<code>brew uninstall node</code>命令来卸载</p>
</li>
<li><p>运行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -rf /usr/local/bin/npm /usr/local/share/main/main1/node* /usr/local/lib/dtrace/node.d ~/.npm ~/.node-gyp</span><br><span class="line"></span><br><span class="line">sudo rm -rf /opt/local/bin/node /opt/local/include/node /opt/local/lib/node_modules</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p><a href="https://blog.csdn.net/zmm13298329239/article/details/83587214" target="_blank" rel="noopener">安装NVM</a></p>
<ul>
<li><p>在安装NVM之前还需要一个C++编译器，在mac上可以安装Xcode命令行工具<br><code>xcode-select -install</code></p>
</li>
<li><p>使用curl或wget安装nvm</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.8/install.sh | bash</span><br><span class="line"></span><br><span class="line">wget -q0- https://raw.githubusercontent.com/creationix/nvm/v0.33.8/install.sh | bash</span><br></pre></td></tr></table></figure>

<p>输入<code>comman -v nvm</code> 查看是否安装成功<br>如果安装失败需要配置环境变量<code>~/.bash_profile</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">export NVM_DIR=&quot;$HOME/.nvm&quot;</span><br><span class="line">[ -s &quot;$NVM_DIR/nvm.sh&quot; ] &amp;&amp; . &quot;$NVM_DIR/nvm.sh&quot;</span><br></pre></td></tr></table></figure>

<p>使环境变量生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.bash_profile</span><br></pre></td></tr></table></figure>

<p>如果配置环境变量还失败需要在<code>.bash_profile</code>文件中添加 <code>source ~/.bashrc</code></p>
</li>
</ul>
</li>
<li><p><a href="https://github.com/nvm-sh/nvm#usage" target="_blank" rel="noopener">安装并切换不同node.js版本</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nvm install stable  安装最新稳定版node.js</span><br><span class="line">nvm install 9.11.1  安装9.11.1版本</span><br><span class="line">nvm install 9.11    安装9.11.x系列最新版本</span><br><span class="line">nvm ls-remote       列出远程服务器上所有可用版本</span><br><span class="line">nvm use 9.11.1      切换到9.11.1</span><br><span class="line">nvm use 9.11        切换到9.11.x 系列最新版</span><br><span class="line">nvm use node        切换到最新版</span><br><span class="line">nvm nvm alias default node  设置默认版本为最新版</span><br><span class="line">nvm ls              列出所有已经安装的版本</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置项目所使用的node.js版本<br>如果项目所需node.js版本不是默认版本，可以在项目根目录创建<code>.nvmrc</code>文件并在其中预先指定版本号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo 9.11.1 &gt; .nvmrc   创建.nvmrc文件</span><br><span class="line">nvm use    运行nmv，将自动安装设定好的版本号</span><br></pre></td></tr></table></figure>



</li>
</ol>
<h2><span id="在npmorg上发布一个模块">在npm.org上发布一个模块</span></h2><ol>
<li><a href="https://www.npmjs.com/signup" target="_blank" rel="noopener">注册账号</a></li>
<li>添加用户名, 密码及邮箱 <code>npm adduser</code></li>
<li>发布 <code>npm publish</code></li>
</ol>
<h2><span id="koa">KOA</span></h2><h3><span id="express和koa的区别">Express和Koa的区别</span></h3><ul>
<li><p>Express4之前主要是基于Connect，封装了大量的功能，如路由，视图处理，错误处理等。Express4之后不再依赖connect,除了express.static外的内置中间件，全部作为单独的模块安装 </p>
</li>
<li><p>Express框架采用ES5语法，异步操作通过传统的回调异步调用，会容易造成回调地狱</p>
</li>
<li><p>Express的插件是顺序执行的，Koa的中间件是基于洋葱模型，可以在中间件中执行请求处理前和请求处理后的代码</p>
</li>
<li><p>Koa不在内核中绑定任何中间件，仅仅提供了一个轻量的函数库，几乎所有功能都需要通过第三方中间件来实现</p>
</li>
</ul>
<p>ES6 generator…yield+promise </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">function* () &#123; yiels xxx; &#125;</span><br></pre></td></tr></table></figure>

<p>ES7 async…await+promise</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">async function() &#123; await xxx; &#125;</span><br></pre></td></tr></table></figure>

<h2><span id="koa安装及搭建">koa安装及搭建</span></h2><p>koa2需要node.js7.6以上，如果低于7.6需要使用babel hook</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">require(&apos;babel-register&apos;)  // babel hook</span><br><span class="line">// 应用的其余require需要放到hook后面</span><br><span class="line">const app = require(&apos;./app&apos;)</span><br></pre></td></tr></table></figure>

<ol>
<li>初始化项目 <code>npm init</code></li>
<li>安装koa <code>npm install koa --save</code></li>
</ol>
<h3><span id="context对象">context对象</span></h3><p>koa将node.js的request和response对象封装到context对象中，context是会话的上下文</p>
<p>context对象内置了一些常用属性，如<code>context.state</code>, <code>context.app</code>, <code>context.cookies</code>, <code>context.throw</code>，也可以在context对象中定义一些属性、配置以供全局使用</p>
<p>koa应用程序中的每个请求都会创建一个context，并在中间件中被作为参数引用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">app.use(async ctx =&gt; &#123;</span><br><span class="line">    ctx            // context</span><br><span class="line">    ctx.request    // koa request</span><br><span class="line">    ctx.response   // koa response</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3><span id="常用属性和方法">常用属性和方法</span></h3><ol>
<li><p><code>ctx.request</code></p>
<p>koa request对象是在node.js的请求对象上的封装</p>
<p>如果要访问node.js的request对象，需要使用 <code>ctx.req</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ctx.request.url           // 获取请求URL</span><br><span class="line">ctx.request.query          // 获取解析后的查询字符串</span><br><span class="line">ctx.request.querystring   // 获取原始查询字符串</span><br><span class="line">ctx.request.method       //  请求类型 POST GET</span><br><span class="line">ctx.request.path         // 请求路径</span><br><span class="line">ctx.request.accepts(&apos;json&apos;) // 期望服务端返回的数据类型</span><br></pre></td></tr></table></figure>

<p>Koa没有封装获取POST请求参数的方法，需要使用node.js请求对象req</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.use(async ctx =&gt; &#123;</span><br><span class="line"> let postdata = &apos;&apos;</span><br><span class="line"> ctx.req.on(&apos;data&apos;, data =&gt; &#123;</span><br><span class="line">     postdata += data</span><br><span class="line"> &#125;)</span><br><span class="line"> ctx.req.on(&apos;end&apos;, () =&gt; &#123;</span><br><span class="line">     console.log(postdata)</span><br><span class="line"> &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>curl命令可以模拟POST请求， <code>-d</code>参数后面是POST请求得从那时</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -d &apos;params1=value1&amp;params2=value2&apos; http://localhost:3000</span><br></pre></td></tr></table></figure>

<p>可以使用<code>koa-bodyparser</code>中间件来获取POST请求得参数</p>
</li>
<li><p>ctx.response</p>
<p>ctx.response是Koa对node.js原生response的抽象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ctx.response.type  // 响应Content-Type类型 html, image/jpeg, text/plain, text</span><br><span class="line">ctx.response.body  // 响应体</span><br><span class="line">ctx.response.status   // 设置响应状态 200 404</span><br><span class="line">ctx.response.is(types...)  // 与ctx.request.is(types…)类似，用来检查响应类型是否是所提供的类型之一</span><br><span class="line">ctx.response.redirect(url, [alt])  // 用于将302状态码重定向到URL，如用户登录后重定向到网站的首页</span><br></pre></td></tr></table></figure>
</li>
<li><p>ctx.state</p>
<p><code>ctx.state</code>是推荐的命名空间，用于通过中间件传递信息和前端视图。类似koa-views这些渲染view层的中间件也会默认把ctx.state里的属性作为view的上下文传入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.state.user = yield User.find(id)</span><br></pre></td></tr></table></figure>

<p>把user属性存放到<code>ctx.state</code>对象里，以便能够被另一个中间件读取</p>
</li>
<li><p>ctx.cookies</p>
<p><code>ctx.cookies</code>用于获取和设置cookie</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ctx.cookies.get(name, [options])  // 获取cookie</span><br><span class="line">ctx.cookies.set(name, value, [options])  // 设置cookie</span><br></pre></td></tr></table></figure>

<p>options的配置：</p>
<table>
<thead>
<tr>
<th>key</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>maxAge</td>
<td>一个以毫秒为单位的数字，表示cookie过期时间</td>
</tr>
<tr>
<td>signed</td>
<td>cookie签名值</td>
</tr>
<tr>
<td>expires</td>
<td>cookie过期的Date</td>
</tr>
<tr>
<td>path</td>
<td>cookie路径，默认/</td>
</tr>
<tr>
<td>domain</td>
<td>cookie域名</td>
</tr>
<tr>
<td>secure</td>
<td>安全cookie,只能使用HTTPS访问</td>
</tr>
<tr>
<td>httpOnly</td>
<td>如果为true,则cookie无法被javascript获取到</td>
</tr>
<tr>
<td>overwrite</td>
<td>一个布尔值，表示是否覆盖以前设置的同名cookie (默认false)</td>
</tr>
</tbody></table>
</li>
<li><p>ctx.throw</p>
<p><code>ctx.throw</code>用于抛出错误，把错误信息返回给用户</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx.throw(500)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2><span id="koa的中间件">koa的中间件</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ctx.method == ctx.request.method == ctx.req.method</span><br><span class="line">ctx.host == ctx.req.url</span><br><span class="line">ctx.url == ctx.request.url == ctx.req.url</span><br><span class="line">ctx.body == ctx.response.body</span><br></pre></td></tr></table></figure>

<p>通过<code>app.use()</code>函数来加载中间件；中间件函数是一个带有ctx和next两个参数的函数</p>
<p>ctx是执行上下文，封装了request和response等对象</p>
<p>next是把中间件的执行权交给下游中间件</p>
<p>使用<code>koa-compose</code>可以将多个中间件组合成一个单一的中间件，便于重用或导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">const compose = require(&apos;koa-compose&apos;)</span><br><span class="line"></span><br><span class="line">const middleware1 = async (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(1)</span><br><span class="line">    await next()</span><br><span class="line">    console.log(&apos;1 end&apos;)</span><br><span class="line">&#125;</span><br><span class="line">const middleware2 = async (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(2)</span><br><span class="line">    await next()</span><br><span class="line">    console.log(&apos;2 end&apos;)</span><br><span class="line">&#125;</span><br><span class="line">const middleware3 = async (ctx, next) =&gt; &#123;</span><br><span class="line">    console.log(3)</span><br><span class="line">    await next()</span><br><span class="line">    console.log(&apos;3 end&apos;)</span><br><span class="line">&#125;</span><br><span class="line">const all = compose([middleware1, middleware2, middleware3])</span><br><span class="line">app.use(all)</span><br></pre></td></tr></table></figure>

<p><a href="https://github.com/koajs/koa/wiki" target="_blank" rel="noopener">常用koa中间件</a></p>
<ol>
<li><p>koa-bodyparser 把post请求的参数解析到<code>ctx.request.body</code>中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const bodyParser = require(&apos;koa-bodyparser&apos;)</span><br><span class="line">app.use(bodyParser())</span><br></pre></td></tr></table></figure>
</li>
<li><p>koa-router  路由处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const Router = require(&apos;koa-router&apos;)</span><br><span class="line">const router = new Router()</span><br><span class="line">router.get(&apos;/&apos;, async (ctx, next) =&gt; &#123;&#125;)</span><br><span class="line">app.use(router.routes())         // 加载koa-router中间件</span><br><span class="line">  .use(router.allowedMethods()) // 对异常状态码的处理</span><br></pre></td></tr></table></figure>
</li>
<li><p>koa-static 静态文件处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">const static = require(&apos;koa-static&apos;)</span><br><span class="line">app.use(static(path.join(__dirname, &apos;/static&apos;)))  // 加载静态资源</span><br></pre></td></tr></table></figure>
</li>
<li><p>Koa-views 模板文件中间件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const views = require(&apos;koa-views&apos;)</span><br><span class="line">app.use(views(__dirname + &apos;/views&apos;, &#123; map: &#123; html: &apos;ejs&apos; &#125; &#125;))  // 加载模板引擎</span><br><span class="line">router.get(&apos;/&apos;, async ctx =&gt; &#123;</span><br><span class="line"> await ctx.render(&apos;index&apos;)    // 渲染index模板</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2><span id="路由">路由</span></h2><p>路由是根据URL的变更重新渲染页面布局和内容的过程</p>
<p>前端路由主要解决了两个问题：在页面不刷新的前提下实现URL的变化；及捕捉URL的变化并执行相应的页面逻辑</p>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">赞赏</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/web/img/donate.jpg">
        <p> 感谢鼓励 </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>

        <div id="lv-container">
        </div>

    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
    <p>
        <span>/</span>
        
        <span><a href="http://www.ssmy.cn">ssmy.cn</a></span>
        <span>/</span>
        
    </p>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/web/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/web/js/index.js"></script>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


    <script>
        /**
         *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
         *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
        */
        if( '' || '')
        var disqus_config = function () {
            this.page.url = '';  // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = ''; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        };

        (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            s.src = 'https://airclouds-blog.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>



</html>
